# STRMSync é¡¹ç›®æ•´ä½“ç»“æ„

**æ›´æ–°æ—¥æœŸï¼š** 2026-02-18

---

## ğŸ“‚ å½“å‰é¡¹ç›®ç»“æ„ï¼ˆv2.0 - é‡æ„åï¼‰

```
strm/
â”œâ”€â”€ backend/                       # åç«¯ä»£ç 
â”‚   â”œâ”€â”€ main.go                   # å…¥å£æ–‡ä»¶
â”‚   â”œâ”€â”€ core/                     # æ ¸å¿ƒæ•°æ®å±‚
â”‚   â”‚   â”œâ”€â”€ database.go           # GORMæ•°æ®åº“ç®¡ç†
â”‚   â”‚   â”œâ”€â”€ models.go             # æ•°æ®åº“æ¨¡å‹ï¼ˆDataServer, MediaServer, Job, TaskRun, Logï¼‰
â”‚   â”‚   â””â”€â”€ repository.go         # ä»“åº“æ¥å£ï¼ˆå·²åºŸå¼ƒï¼Œå¾…åˆ é™¤ï¼‰
â”‚   â”œâ”€â”€ filesystem/               # æ–‡ä»¶ç³»ç»ŸæŠ½è±¡å±‚ï¼ˆæ•°æ®è®¿é—®å±‚ï¼‰
â”‚   â”‚   â”œâ”€â”€ interfaces.go         # Client æ¥å£å®šä¹‰
â”‚   â”‚   â”œâ”€â”€ types.go              # RemoteFile, FileEvent ç­‰ç±»å‹
â”‚   â”‚   â”œâ”€â”€ client.go             # FilesystemClient æ€»å…¥å£
â”‚   â”‚   â”œâ”€â”€ clouddrive2.go        # CloudDrive2 Provider
â”‚   â”‚   â”œâ”€â”€ openlist.go           # OpenList Provider
â”‚   â”‚   â”œâ”€â”€ local.go              # Local Provider
â”‚   â”‚   â””â”€â”€ clouddrive2_proto/    # CloudDrive2 gRPC proto
â”‚   â”œâ”€â”€ mediaserver/              # åª’ä½“æœåŠ¡å™¨å®¢æˆ·ç«¯
â”‚   â”‚   â”œâ”€â”€ emby.go               # Emby å®¢æˆ·ç«¯
â”‚   â”‚   â””â”€â”€ jellyfin.go           # Jellyfin å®¢æˆ·ç«¯
â”‚   â”œâ”€â”€ handler/                  # HTTP Handlerï¼ˆGinè·¯ç”±å¤„ç†ï¼‰
â”‚   â”‚   â”œâ”€â”€ server.go             # DataServer/MediaServer CRUD
â”‚   â”‚   â”œâ”€â”€ job.go                # Job CRUD + æ‰‹åŠ¨è§¦å‘
â”‚   â”‚   â”œâ”€â”€ run.go                # TaskRun æŸ¥è¯¢
â”‚   â”‚   â”œâ”€â”€ log.go                # æ—¥å¿—æŸ¥è¯¢
â”‚   â”‚   â”œâ”€â”€ file.go               # æ–‡ä»¶åˆ—è¡¨ï¼ˆå¸¦é€’å½’æ·±åº¦é™åˆ¶ï¼‰
â”‚   â”‚   â””â”€â”€ health.go             # å¥åº·æ£€æŸ¥
â”‚   â”œâ”€â”€ service/                  # ä¸šåŠ¡é€»è¾‘å±‚
â”‚   â”‚   â”œâ”€â”€ interfaces.go         # LogService æ¥å£ï¼ˆæœªå®ç°ï¼‰
â”‚   â”‚   â”œâ”€â”€ types.go              # è¯·æ±‚/å“åº”ç±»å‹
â”‚   â”‚   â”œâ”€â”€ file.go               # æ–‡ä»¶æœåŠ¡ï¼ˆListï¼‰
â”‚   â”‚   â””â”€â”€ executor.go           # Jobæ‰§è¡Œå™¨ï¼ˆç›´æ¥åœ¨goroutineä¸­æ‰§è¡Œï¼Œæ— é˜Ÿåˆ—ï¼‰
â”‚   â””â”€â”€ utils/                    # å·¥å…·åŒ…
â”‚       â”œâ”€â”€ logger.go             # Zapæ—¥å¿—ï¼ˆè¾“å‡ºåˆ°stdoutï¼‰
â”‚       â”œâ”€â”€ request_id.go         # è¯·æ±‚IDä¸­é—´ä»¶
â”‚       â”œâ”€â”€ crypto.go             # åŠ å¯†å·¥å…·
â”‚       â”œâ”€â”€ hash.go               # å“ˆå¸Œå·¥å…·
â”‚       â””â”€â”€ path.go               # è·¯å¾„å·¥å…·
â”‚
â”œâ”€â”€ frontend/                     # å‰ç«¯ä»£ç ï¼ˆå¾…é‡æ„ï¼‰
â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”œâ”€â”€ views/                # é¡µé¢ç»„ä»¶
â”‚   â”‚   â”œâ”€â”€ layouts/              # å¸ƒå±€ç»„ä»¶
â”‚   â”‚   â”œâ”€â”€ api/                  # APIå®¢æˆ·ç«¯
â”‚   â”‚   â””â”€â”€ router/               # è·¯ç”±é…ç½®
â”‚   â””â”€â”€ dist/                     # ç¼–è¯‘è¾“å‡º
â”‚
â”œâ”€â”€ docs/                         # æ–‡æ¡£
â”‚   â”œâ”€â”€ PROJECT_SUMMARY.md        # é¡¹ç›®æ¦‚è¿°
â”‚   â”œâ”€â”€ DEVELOPMENT_STATUS.md     # å¼€å‘çŠ¶æ€
â”‚   â”œâ”€â”€ START_GUIDE.md            # å¿«é€Ÿå¼€å§‹
â”‚   â”œâ”€â”€ TESTING_GUIDE.md          # æµ‹è¯•æŒ‡å—
â”‚   â”œâ”€â”€ IMPLEMENTATION_UPDATES.md # å®æ–½æ–¹æ¡ˆæ›´æ–°
â”‚   â”œâ”€â”€ RECURSIVE_DEPTH_LIMIT.md  # é€’å½’æ·±åº¦é™åˆ¶æ–‡æ¡£
â”‚   â”œâ”€â”€ OPTIMIZATION_PLAN.md      # æ¶æ„ä¼˜åŒ–æ–¹æ¡ˆï¼ˆæœ¬æ¬¡ï¼‰
â”‚   â”œâ”€â”€ TEST_RESULTS.md           # æµ‹è¯•ç»“æœ
â”‚   â””â”€â”€ reference-projects/       # å‚è€ƒé¡¹ç›®åˆ†æ
â”‚       â”œâ”€â”€ qmediasync_backend_analysis.md
â”‚       â””â”€â”€ q115_frontend_analysis.md
â”‚
â”œâ”€â”€ scripts/                      # è„šæœ¬
â”‚   â””â”€â”€ ...
â”‚
â”œâ”€â”€ Makefile                      # æ„å»ºè„šæœ¬
â”œâ”€â”€ go.mod                        # Goä¾èµ–ç®¡ç†
â””â”€â”€ test.env                      # æµ‹è¯•ç¯å¢ƒé…ç½®
```

---

## ğŸ¯ ä¼˜åŒ–åçš„ç›®æ ‡ç»“æ„ï¼ˆv2.1 è®¡åˆ’ï¼‰

```
strm/
â”œâ”€â”€ backend/
â”‚   â”œâ”€â”€ main.go
â”‚   â”‚
â”‚   â”œâ”€â”€ core/                     # æ ¸å¿ƒæ•°æ®å±‚ï¼ˆä¸å˜ï¼‰
â”‚   â”‚   â”œâ”€â”€ database.go
â”‚   â”‚   â””â”€â”€ models.go
â”‚   â”‚
â”‚   â”œâ”€â”€ filesystem/               # æ–‡ä»¶ç³»ç»ŸæŠ½è±¡å±‚ï¼ˆä¿æŒä¸å˜ï¼Œä½œä¸ºåº•å±‚ï¼‰
â”‚   â”‚   â”œâ”€â”€ interfaces.go         # Client æ¥å£
â”‚   â”‚   â”œâ”€â”€ types.go
â”‚   â”‚   â”œâ”€â”€ client.go
â”‚   â”‚   â”œâ”€â”€ clouddrive2.go        # [æ‰©å±•] æ·»åŠ  Stat, BuildStrmInfo æ–¹æ³•
â”‚   â”‚   â”œâ”€â”€ openlist.go           # [æ‰©å±•] æ·»åŠ  Stat æ–¹æ³•
â”‚   â”‚   â”œâ”€â”€ local.go              # [æ‰©å±•] æ·»åŠ  Stat æ–¹æ³•
â”‚   â”‚   â””â”€â”€ clouddrive2_proto/
â”‚   â”‚
â”‚   â”œâ”€â”€ syncengine/               # [æ–°å¢] åŒæ­¥å¼•æ“å±‚ï¼ˆæ ¸å¿ƒä¸šåŠ¡é€»è¾‘ï¼‰
â”‚   â”‚   â”œâ”€â”€ interfaces.go         # driverImpl æ¥å£å®šä¹‰
â”‚   â”‚   â”œâ”€â”€ types.go              # RemoteEntry, StrmInfo, SyncContext, TaskRunSummary
â”‚   â”‚   â”œâ”€â”€ engine.go             # SyncEngine å®ç°ï¼ˆRunOnce, RunWatchï¼‰
â”‚   â”‚   â””â”€â”€ errors.go             # è‡ªå®šä¹‰é”™è¯¯ç±»å‹
â”‚   â”‚
â”‚   â”œâ”€â”€ filesystemdriver/         # [æ–°å¢] æ–‡ä»¶ç³»ç»Ÿé€‚é…å™¨å±‚
â”‚   â”‚   â”œâ”€â”€ adapter.go            # filesystem.Client -> driverImpl é€‚é…å™¨
â”‚   â”‚   â”œâ”€â”€ clouddrive2_adapter.go # CloudDrive2 ç‰¹åŒ–é€‚é…
â”‚   â”‚   â”œâ”€â”€ openlist_adapter.go   # OpenList ç‰¹åŒ–é€‚é…
â”‚   â”‚   â””â”€â”€ local_adapter.go      # Local ç‰¹åŒ–é€‚é…
â”‚   â”‚
â”‚   â”œâ”€â”€ strmwriter/               # [æ–°å¢] STRM æ–‡ä»¶å†™å…¥å™¨
â”‚   â”‚   â”œâ”€â”€ interfaces.go         # StrmWriter æ¥å£
â”‚   â”‚   â”œâ”€â”€ local_writer.go       # æœ¬åœ°æ–‡ä»¶ç³»ç»Ÿå†™å…¥å™¨
â”‚   â”‚   â””â”€â”€ remote_writer.go      # è¿œç¨‹æ–‡ä»¶ç³»ç»Ÿå†™å…¥å™¨ï¼ˆæœªæ¥æ‰©å±•ï¼‰
â”‚   â”‚
â”‚   â”œâ”€â”€ syncqueue/                # [æ–°å¢] å¼‚æ­¥é˜Ÿåˆ—ç®¡ç†
â”‚   â”‚   â”œâ”€â”€ queue.go              # SyncQueue å®ç°ï¼ˆå¸¦å»é‡å’Œå¹¶å‘æ§åˆ¶ï¼‰
â”‚   â”‚   â””â”€â”€ types.go              # QueueItem ç±»å‹
â”‚   â”‚
â”‚   â”œâ”€â”€ scheduler/                # [æ–°å¢] Cron è°ƒåº¦å™¨
â”‚   â”‚   â”œâ”€â”€ scheduler.go          # å…¨å±€ Scheduler
â”‚   â”‚   â””â”€â”€ types.go              # è°ƒåº¦ç›¸å…³ç±»å‹
â”‚   â”‚
â”‚   â”œâ”€â”€ mediaserver/              # åª’ä½“æœåŠ¡å™¨å®¢æˆ·ç«¯ï¼ˆä¸å˜ï¼‰
â”‚   â”‚   â”œâ”€â”€ emby.go
â”‚   â”‚   â””â”€â”€ jellyfin.go
â”‚   â”‚
â”‚   â”œâ”€â”€ handler/                  # HTTP Handlerï¼ˆè½»å¾®è°ƒæ•´ï¼‰
â”‚   â”‚   â”œâ”€â”€ server.go
â”‚   â”‚   â”œâ”€â”€ job.go                # [ä¿®æ”¹] ä½¿ç”¨ Queue è€Œéç›´æ¥æ‰§è¡Œ
â”‚   â”‚   â”œâ”€â”€ run.go
â”‚   â”‚   â”œâ”€â”€ log.go
â”‚   â”‚   â”œâ”€â”€ file.go
â”‚   â”‚   â””â”€â”€ health.go
â”‚   â”‚
â”‚   â”œâ”€â”€ service/                  # ä¸šåŠ¡é€»è¾‘å±‚ï¼ˆå¤§å¹…é‡æ„ï¼‰
â”‚   â”‚   â”œâ”€â”€ interfaces.go         # LogService æ¥å£
â”‚   â”‚   â”œâ”€â”€ types.go
â”‚   â”‚   â”œâ”€â”€ file.go
â”‚   â”‚   â”œâ”€â”€ log_service.go        # [æ–°å¢] LogService å®ç°
â”‚   â”‚   â””â”€â”€ executor.go           # [é‡æ„] ä½¿ç”¨ SyncEngine + Queue
â”‚   â”‚
â”‚   â””â”€â”€ utils/                    # å·¥å…·åŒ…ï¼ˆä¸å˜ï¼‰
â”‚       â”œâ”€â”€ logger.go
â”‚       â”œâ”€â”€ request_id.go
â”‚       â”œâ”€â”€ crypto.go
â”‚       â”œâ”€â”€ hash.go
â”‚       â””â”€â”€ path.go
â”‚
â”œâ”€â”€ frontend/                     # å‰ç«¯ï¼ˆæœªæ¥é‡æ„ï¼‰
â”‚
â”œâ”€â”€ docs/                         # æ–‡æ¡£ï¼ˆæŒç»­æ›´æ–°ï¼‰
â”‚
â”œâ”€â”€ scripts/
â”œâ”€â”€ Makefile
â”œâ”€â”€ go.mod
â””â”€â”€ test.env
```

---

## ğŸ”„ æ¶æ„å±‚æ¬¡å¯¹æ¯”

### å½“å‰æ¶æ„ï¼ˆv2.0ï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         Handler Layer (Gin)             â”‚  <- HTTP è·¯ç”±å’Œè¯·æ±‚å¤„ç†
â”‚  server.go, job.go, run.go, file.go     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚       Service Layer (ä¸šåŠ¡é€»è¾‘)          â”‚  <- è–„ä¸šåŠ¡å±‚ï¼Œä¸»è¦è½¬å‘
â”‚  executor.go, file.go, interfaces.go    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    Filesystem Layer (æ•°æ®è®¿é—®)          â”‚  <- ç›´æ¥è®¿é—®æ–‡ä»¶ç³»ç»Ÿ
â”‚  CloudDrive2, OpenList, Local           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      Core Layer (æ•°æ®æ¨¡å‹)              â”‚  <- GORM + SQLite
â”‚  models.go, database.go                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**é—®é¢˜ï¼š**
- âŒ Service å±‚å¤ªè–„ï¼Œç¼ºå°‘æ ¸å¿ƒä¸šåŠ¡é€»è¾‘
- âŒ æ²¡æœ‰ç»Ÿä¸€çš„é©±åŠ¨æ¥å£ï¼Œfilesystem ç›´æ¥æš´éœ²åº•å±‚ç»†èŠ‚
- âŒ æ²¡æœ‰åŒæ­¥å¼•æ“ï¼Œé€»è¾‘åˆ†æ•£åœ¨ executor ä¸­
- âŒ æ²¡æœ‰é˜Ÿåˆ—ç®¡ç†ï¼Œgoroutine ç›´æ¥æ‰§è¡Œ
- âŒ æ²¡æœ‰ STRM å†…å®¹æ¯”å¯¹ï¼Œæ¯æ¬¡éƒ½é‡å†™
- âŒ LogService åªæ˜¯ç©ºæ¥å£ï¼Œæœªå®ç°

---

### ä¼˜åŒ–åæ¶æ„ï¼ˆv2.1ï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         Handler Layer (Gin)             â”‚  <- HTTP è·¯ç”±å’Œè¯·æ±‚å¤„ç†
â”‚  server.go, job.go, run.go, file.go     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      Application Layer (åº”ç”¨å±‚)         â”‚  <- è°ƒåº¦å’Œé˜Ÿåˆ—ç®¡ç†
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚ Scheduler  â”‚â”€â”€â”€â”€â”€â”€â”‚ SyncQueue  â”‚     â”‚
â”‚  â”‚  (Cron)    â”‚      â”‚ (errgroup) â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚       Service Layer (ä¸šåŠ¡é€»è¾‘)          â”‚  <- æ ¸å¿ƒä¸šåŠ¡ç¼–æ’
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚      SyncEngine (åŒæ­¥å¼•æ“)       â”‚    â”‚
â”‚  â”‚  - RunOnce (ä¸€æ¬¡æ€§åŒæ­¥)         â”‚    â”‚
â”‚  â”‚  - RunWatch (æŒç»­ç›‘å¬)          â”‚    â”‚
â”‚  â”‚  - CompareStrm (å†…å®¹æ¯”å¯¹)       â”‚    â”‚
â”‚  â”‚  - buildSyncPlans (æ„å»ºè®¡åˆ’)    â”‚    â”‚
â”‚  â”‚  - applyPlans (åº”ç”¨è®¡åˆ’)        â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚     LogService (æ—¥å¿—æœåŠ¡)        â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      Driver Layer (é©±åŠ¨æŠ½è±¡å±‚)          â”‚  <- ç»Ÿä¸€é©±åŠ¨æ¥å£
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚      driverImpl æ¥å£             â”‚    â”‚
â”‚  â”‚  - List (åˆ—è¡¨)                   â”‚    â”‚
â”‚  â”‚  - Stat (å…ƒæ•°æ®)                 â”‚    â”‚
â”‚  â”‚  - Watch (ç›‘æ§)                  â”‚    â”‚
â”‚  â”‚  - BuildStrmInfo (ç”ŸæˆSTRM)     â”‚    â”‚
â”‚  â”‚  - CompareStrm (å†…å®¹æ¯”å¯¹)       â”‚    â”‚
â”‚  â”‚  - Capabilities (èƒ½åŠ›å£°æ˜)      â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚  â”‚  Adapter   â”‚ â”‚  Adapter   â”‚ ...     â”‚
â”‚  â”‚ (CD2)      â”‚ â”‚ (OpenList) â”‚         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Filesystem Layer (æ•°æ®è®¿é—®)           â”‚  <- åº•å±‚æ–‡ä»¶ç³»ç»Ÿè®¿é—®
â”‚  CloudDrive2, OpenList, Local Provider  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    Infrastructure Layer (åŸºç¡€è®¾æ–½)      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚  â”‚StrmWriter  â”‚ â”‚  Database  â”‚         â”‚
â”‚  â”‚(æ–‡ä»¶å†™å…¥)  â”‚ â”‚  (GORM)    â”‚         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**æ”¹è¿›ï¼š**
- âœ… **æ¸…æ™°çš„åˆ†å±‚**ï¼šåº”ç”¨å±‚(è°ƒåº¦) â†’ ä¸šåŠ¡å±‚(å¼•æ“) â†’ é©±åŠ¨å±‚(æŠ½è±¡) â†’ æ•°æ®å±‚(è®¿é—®)
- âœ… **ç»Ÿä¸€é©±åŠ¨æ¥å£**ï¼šdriverImpl å±è”½åº•å±‚å·®å¼‚
- âœ… **ç‹¬ç«‹åŒæ­¥å¼•æ“**ï¼šSyncEngine å°è£…æ ¸å¿ƒåŒæ­¥é€»è¾‘
- âœ… **é˜Ÿåˆ—ç®¡ç†**ï¼šSyncQueue + errgroup.SetLimit æ§åˆ¶å¹¶å‘
- âœ… **Cronè°ƒåº¦**ï¼šScheduler ç»Ÿä¸€ç®¡ç†å®šæ—¶ä»»åŠ¡
- âœ… **å†…å®¹æ¯”å¯¹**ï¼šCompareStrm é¿å…é‡å¤å†™å…¥
- âœ… **æ—¥å¿—ç³»ç»Ÿ**ï¼šLogService å®ç°å¼‚æ­¥æ—¥å¿—å†™å…¥

---

## ğŸ“Š æ ¸å¿ƒæ¨¡å—èŒè´£å¯¹æ¯”

| æ¨¡å— | v2.0 å½“å‰èŒè´£ | v2.1 ä¼˜åŒ–åèŒè´£ | å˜åŒ– |
|------|---------------|-----------------|------|
| **Handler** | HTTPè¯·æ±‚å¤„ç†ï¼Œç›´æ¥è°ƒç”¨Service | HTTPè¯·æ±‚å¤„ç†ï¼Œå…¥é˜Ÿåˆ°Queue | è½»å¾®è°ƒæ•´ |
| **Service/Executor** | è–„é€»è¾‘å±‚ï¼Œç›´æ¥ä½¿ç”¨filesystem | ä½¿ç”¨SyncEngineç¼–æ’åŒæ­¥æµç¨‹ | é‡æ„ |
| **SyncEngine** | âŒ ä¸å­˜åœ¨ | âœ… æ ¸å¿ƒåŒæ­¥å¼•æ“ï¼ˆScanâ†’Diffâ†’Applyï¼‰ | **æ–°å¢** |
| **driverImpl** | âŒ ä¸å­˜åœ¨ | âœ… ç»Ÿä¸€é©±åŠ¨æ¥å£ï¼Œå±è”½åº•å±‚å·®å¼‚ | **æ–°å¢** |
| **Filesystem** | æ•°æ®è®¿é—®å±‚ï¼ˆ3ä¸ªproviderï¼‰ | æ•°æ®è®¿é—®å±‚ï¼ˆä¿æŒä¸å˜ï¼Œä½†æ‰©å±•æ–¹æ³•ï¼‰ | æ‰©å±• |
| **Adapter** | âŒ ä¸å­˜åœ¨ | âœ… filesystem â†’ driverImpl é€‚é… | **æ–°å¢** |
| **SyncQueue** | âŒ ä¸å­˜åœ¨ | âœ… å¼‚æ­¥é˜Ÿåˆ—ï¼Œå»é‡+å¹¶å‘æ§åˆ¶ | **æ–°å¢** |
| **Scheduler** | âŒ ä¸å­˜åœ¨ | âœ… å…¨å±€Cronè°ƒåº¦å™¨ | **æ–°å¢** |
| **LogService** | ç©ºæ¥å£ | å®ç°å¼‚æ­¥æ—¥å¿—å†™å…¥æ•°æ®åº“ | å®ç° |
| **StrmWriter** | âŒ ä¸å­˜åœ¨ | âœ… æŠ½è±¡æ–‡ä»¶å†™å…¥ï¼ˆä¾¿äºæµ‹è¯•ï¼‰ | **æ–°å¢** |

---

## ğŸ”‘ å…³é”®è®¾è®¡å˜åŒ–

### 1. é©±åŠ¨æŠ½è±¡ï¼ˆdriverImplï¼‰

**v2.0ï¼š**
```go
// filesystem.Client - æ•°æ®è®¿é—®æ¥å£
type Client interface {
    List(ctx, path, recursive, maxDepth) ([]RemoteFile, error)
    BuildStreamURL(ctx, path) (string, error)  // åªè¿”å›å­—ç¬¦ä¸²
}
```

**v2.1ï¼š**
```go
// driverImpl - é¢å‘åŒæ­¥å¼•æ“çš„é©±åŠ¨æ¥å£
type driverImpl interface {
    Capabilities() DriverCapability  // èƒ½åŠ›å£°æ˜
    List(ctx, path, opt) ([]RemoteEntry, error)
    Stat(ctx, path) (RemoteEntry, error)  // æ–°å¢ï¼šå•æ–‡ä»¶æŸ¥è¯¢
    BuildStrmInfo(ctx, req) (StrmInfo, error)  // ç»“æ„åŒ–STRMä¿¡æ¯
    CompareStrm(ctx, input) (CompareResult, error)  // æ–°å¢ï¼šå†…å®¹æ¯”å¯¹
    Watch(ctx, path, opt) (<-chan DriverEvent, error)
}

// StrmInfo - ç»“æ„åŒ–STRMä¿¡æ¯
type StrmInfo struct {
    RawURL    string     // å†™å…¥.strmçš„å†…å®¹
    BaseURL   *url.URL   // è§£æåçš„base
    Path      string     // è·¯å¾„
    PickCode  string     // 115 PickCode
    Sign      string     // ç­¾å
    ExpiresAt time.Time  // è¿‡æœŸæ—¶é—´
}
```

### 2. åŒæ­¥å¼•æ“ï¼ˆSyncEngineï¼‰

**v2.0ï¼š**
```go
// executor.go - é€»è¾‘åˆ†æ•£ï¼Œç›´æ¥æ“ä½œæ–‡ä»¶ç³»ç»Ÿ
func (e *Executor) Execute(ctx, jobID) error {
    go func() {
        // 1. è·å–jobé…ç½®
        // 2. åˆ›å»ºfilesystem client
        // 3. Listæ–‡ä»¶
        // 4. ç”ŸæˆSTRMï¼ˆæ¯æ¬¡éƒ½é‡å†™ï¼‰
        // 5. å†™å…¥æ–‡ä»¶
        // 6. æ›´æ–°æ•°æ®åº“
    }()
}
```

**v2.1ï¼š**
```go
// engine.go - æ¸…æ™°çš„å·¥ä½œæµ
func (e *SyncEngine) RunOnce(ctx, sctx) (*TaskRunSummary, error) {
    // é˜¶æ®µ1: æ‰«ææºç›®å½•
    entries := driver.List(ctx, sctx.SourceRoot, opt)

    // é˜¶æ®µ2: æ„å»ºåŒæ­¥è®¡åˆ’
    plans := buildSyncPlans(ctx, entries)
    // - è¿‡æ»¤ç›®å½•å’Œæ‰©å±•å
    // - BuildStrmInfo æ„å»ºæœŸæœ›å†…å®¹
    // - CompareStrm æ¯”å¯¹ç°æœ‰å†…å®¹
    // - å†³å®šæ“ä½œç±»å‹ï¼ˆCreate/Update/Skip/Deleteï¼‰

    // é˜¶æ®µ3: å¹¶å‘åº”ç”¨è®¡åˆ’ï¼ˆerrgroup.SetLimitï¼‰
    applyPlans(ctx, plans, summary)

    // é˜¶æ®µ4: æ¸…ç†å­¤å„¿æ–‡ä»¶
    cleanupOrphans(ctx, entries, summary)

    return summary, nil
}
```

### 3. é˜Ÿåˆ—ç®¡ç†ï¼ˆSyncQueueï¼‰

**v2.0ï¼š**
```go
// ç›´æ¥å¯åŠ¨goroutineï¼Œæ— æ§åˆ¶
func (e *Executor) Execute(ctx, jobID) error {
    go func() {
        e.executeJob(context.Background(), jobID)
    }()
    return nil
}
// é—®é¢˜ï¼š
// - é‡å¤è§¦å‘ä¼šå¯åŠ¨å¤šä¸ªgoroutine
// - æ— å¹¶å‘é™åˆ¶
// - æ— å»é‡
```

**v2.1ï¼š**
```go
// syncqueue.go - å¸¦å»é‡å’Œå¹¶å‘æ§åˆ¶
type SyncQueue struct {
    ch       chan QueueItem
    workers  int
    running  map[uint]struct{}  // å»é‡
}

func (q *SyncQueue) Enqueue(item QueueItem) bool {
    if _, exists := q.running[item.JobID]; exists {
        return false  // å»é‡ï¼šå·²åœ¨è¿è¡Œä¸­
    }
    q.running[item.JobID] = struct{}{}
    q.ch <- item
    return true
}

func (q *SyncQueue) Run(ctx, handle) error {
    g, gctx := errgroup.WithContext(ctx)
    g.SetLimit(q.workers)  // å¹¶å‘æ§åˆ¶
    // workeræ± å¤„ç†é˜Ÿåˆ—
}
```

### 4. CompareStrmï¼ˆé¿å…é‡å¤å†™å…¥ï¼‰

**v2.0ï¼š**
```go
// æ¯æ¬¡éƒ½é‡å†™STRMæ–‡ä»¶ï¼Œæ— æ¯”å¯¹
strmURL := client.BuildStreamURL(ctx, remotePath)
os.WriteFile(targetPath, []byte(strmURL), 0644)  // ç›´æ¥å†™å…¥
```

**v2.1ï¼š**
```go
// buildSyncPlans ä¸­çš„æ¯”å¯¹é€»è¾‘
expected := driver.BuildStrmInfo(ctx, req)
actualRaw := writer.Read(ctx, targetPath)
result := driver.CompareStrm(ctx, CompareInput{expected, actualRaw})

if result.Equal {
    plan.Op = SyncOpSkip  // å†…å®¹ä¸€è‡´ï¼Œè·³è¿‡
} else if result.NeedUpdate {
    plan.Op = SyncOpUpdate  // éœ€è¦æ›´æ–°
} else {
    plan.Op = SyncOpCreate  // ä¸å­˜åœ¨ï¼Œåˆ›å»º
}
```

---

## ğŸ¯ æ•°æ®æµå¯¹æ¯”

### v2.0 æ•°æ®æµ

```
ç”¨æˆ·è§¦å‘ â†’ Handler â†’ Executor.Execute
                          â†“
                    å¯åŠ¨goroutine
                          â†“
                   filesystem.List
                          â†“
                 BuildStreamURL (string)
                          â†“
                  os.WriteFile (ç›´æ¥å†™å…¥)
                          â†“
                    æ›´æ–°æ•°æ®åº“
```

### v2.1 æ•°æ®æµ

```
ç”¨æˆ·è§¦å‘ â†’ Handler â†’ SyncQueue.Enqueue (å»é‡)
                          â†“
                    Queue Workers (å¹¶å‘æ§åˆ¶)
                          â†“
                   Executor.handleQueueItem
                          â†“
                   SyncEngine.RunOnce
                          â†“
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚                               â”‚
    driver.List                    driver.BuildStrmInfo
      (RemoteEntry)                   (StrmInfoç»“æ„åŒ–)
            â”‚                               â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
                  driver.CompareStrm (å†…å®¹æ¯”å¯¹)
                            â†“
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚             â”‚             â”‚
           Skip          Update        Create
         (è·³è¿‡)      (writer.Write)  (writer.Write)
                            â”‚
                            â†“
                      æ›´æ–°æ•°æ®åº“
```

---

## ğŸ“ˆ æ€§èƒ½ä¼˜åŠ¿é¢„æµ‹

| æŒ‡æ ‡ | v2.0 å½“å‰ | v2.1 ä¼˜åŒ–å | æå‡ |
|------|-----------|-------------|------|
| **10000æ–‡ä»¶åŒæ­¥æ—¶é—´** | ~10åˆ†é’Ÿ | ~5åˆ†é’Ÿ | 50% â¬† |
| **é‡å¤åŒæ­¥æ—¶IOPS** | 100% | 20% | 80% â¬‡ |
| **å†…å­˜å ç”¨** | ~800MB | ~500MB | 37.5% â¬‡ |
| **å¹¶å‘æ§åˆ¶** | âŒ æ— é™åˆ¶ | âœ… errgroup.SetLimit | N/A |
| **å»é‡èƒ½åŠ›** | âŒ æ—  | âœ… é˜Ÿåˆ—å»é‡ | N/A |

**å…³é”®ä¼˜åŒ–ç‚¹ï¼š**
1. **CompareStrm** - é¿å…80%çš„é‡å¤å†™å…¥
2. **å¹¶å‘æ§åˆ¶** - errgroup.SetLimit é˜²æ­¢goroutineçˆ†ç‚¸
3. **é˜Ÿåˆ—å»é‡** - é˜²æ­¢é‡å¤ä»»åŠ¡
4. **ç»“æ„åŒ–æ—¥å¿—** - å¼‚æ­¥å†™å…¥ä¸é˜»å¡ä¸»æµç¨‹

---

## ğŸš€ è¿ç§»è·¯å¾„

### é˜¶æ®µ1ï¼šWeek 1 - é©±åŠ¨å±‚
- åˆ›å»º `syncengine/`, `filesystemdriver/`, `strmwriter/`
- å®ç°é€‚é…å™¨
- **å‘åå…¼å®¹**ï¼šæ—§ä»£ç ç»§ç»­ä½¿ç”¨ filesystem.Client

### é˜¶æ®µ2ï¼šWeek 2 - å¼•æ“å±‚
- å®ç° SyncEngine
- å®ç° CompareStrm
- **æ¸è¿›å¼åˆ‡æ¢**ï¼šæ–°Jobä½¿ç”¨SyncEngineï¼Œæ—§Jobä¿æŒä¸å˜

### é˜¶æ®µ3ï¼šWeek 3 - åº”ç”¨å±‚
- å®ç° SyncQueue, Scheduler, LogService
- ä¿®æ”¹ Executor ä½¿ç”¨é˜Ÿåˆ—
- **å…¨é‡åˆ‡æ¢**ï¼šæ‰€æœ‰Jobé€šè¿‡é˜Ÿåˆ—æ‰§è¡Œ

### é˜¶æ®µ4ï¼šWeek 4 - æµ‹è¯•å‘å¸ƒ
- å®Œæ•´æµ‹è¯•
- æ€§èƒ½éªŒè¯
- æ–‡æ¡£æ›´æ–°

---

**å…³é”®åŸåˆ™ï¼š**
- âœ… ä¿æŒå‘åå…¼å®¹
- âœ… æ¸è¿›å¼è¿ç§»
- âœ… å……åˆ†æµ‹è¯•
- âœ… æ€§èƒ½éªŒè¯

---

**ä¸‹ä¸€æ­¥ï¼š** å¼€å§‹å®æ–½ Week 1 - ç»Ÿä¸€é©±åŠ¨å±‚ï¼Ÿ
