# æ¶æ„é‡æ„å®Œæˆæ€»ç»“

## æ¦‚è¿°

å·²å®Œæˆåç«¯é¡¹ç›®çš„å®Œæ•´æ¶æ„é‡æ„ï¼Œé‡‡ç”¨åˆ†å±‚æ¶æ„å’Œ DDD é£æ ¼ï¼Œæå‡ä»£ç å¯ç»´æŠ¤æ€§å’Œå¯æ‰©å±•æ€§ã€‚

## é‡æ„é˜¶æ®µ

### Stage 1: æ ¸å¿ƒå±‚è¿ç§» âœ…
- **æäº¤**: `2eda78c` - refactor(stage1): å®Œæˆæ¶æ„é‡æ„ Stage 1 - æ ¸å¿ƒå±‚è¿ç§»
- **æ–‡ä»¶å˜æ›´**: 59 files changed, 869 insertions(+), 402 deletions(-)
- **å®Œæˆå†…å®¹**:
  - åˆ›å»ºé¢†åŸŸå±‚ (internal/domain/)
  - è¿ç§»åŸºç¡€è®¾æ–½å±‚ (internal/infra/)
  - è¿ç§»æ ¸å¿ƒä¸šåŠ¡å±‚ (internal/)
  - åˆ›å»ºå·¥å…·åŒ…å±‚ (internal/pkg/)

### Stage 2: åº”ç”¨å±‚å’Œä¼ è¾“å±‚è¿ç§» âœ…
- **æäº¤**: `79aefce` - refactor(stage2): å®Œæˆæ¶æ„é‡æ„ Stage 2 - åº”ç”¨å±‚å’Œä¼ è¾“å±‚è¿ç§»
- **æ–‡ä»¶å˜æ›´**: 19 files changed, 61 insertions(+), 25 deletions(-)
- **å®Œæˆå†…å®¹**:
  - service/ â†’ internal/app/service/
  - handler/ â†’ internal/transport/http/
  - æ›´æ–°æ‰€æœ‰å¯¼å…¥è·¯å¾„

### Stage 3: æ¸…ç†å’Œä¼˜åŒ– âœ…
- **æäº¤**: `ec12a99` - refactor(stage3): ä¿®å¤æµ‹è¯•å¹¶å®Œæˆæ¶æ„é‡æ„æ¸…ç†
- **æ–‡ä»¶å˜æ›´**: 5 files changed, 150 insertions(+), 58 deletions(-)
- **å®Œæˆå†…å®¹**:
  - ä¿®å¤æ‰€æœ‰æµ‹è¯•æ–‡ä»¶
  - éªŒè¯ç¼–è¯‘å’Œæµ‹è¯•
  - æ¸…ç†å’Œæ–‡æ¡£

## æœ€ç»ˆé¡¹ç›®ç»“æ„

```
backend/
â”œâ”€â”€ internal/
â”‚   â”œâ”€â”€ domain/                    # é¢†åŸŸå±‚
â”‚   â”‚   â”œâ”€â”€ model/                 # é¢†åŸŸæ¨¡å‹ï¼ˆJob, DataServer, TaskRunç­‰ï¼‰
â”‚   â”‚   â””â”€â”€ repository/            # ä»“å‚¨æ¥å£å®šä¹‰
â”‚   â”‚
â”‚   â”œâ”€â”€ infra/                     # åŸºç¡€è®¾æ–½å±‚
â”‚   â”‚   â”œâ”€â”€ filesystem/            # æ–‡ä»¶ç³»ç»Ÿå®¢æˆ·ç«¯
â”‚   â”‚   â”‚   â”œâ”€â”€ clouddrive2/       # CloudDrive2 provider
â”‚   â”‚   â”‚   â”œâ”€â”€ local/             # æœ¬åœ°æ–‡ä»¶ç³»ç»Ÿ provider
â”‚   â”‚   â”‚   â””â”€â”€ openlist/          # OpenList provider
â”‚   â”‚   â”œâ”€â”€ mediaserver/           # åª’ä½“æœåŠ¡å™¨å®¢æˆ·ç«¯
â”‚   â”‚   â”‚   â”œâ”€â”€ emby/              # Emby adapter
â”‚   â”‚   â”‚   â””â”€â”€ jellyfin/          # Jellyfin adapter
â”‚   â”‚   â”œâ”€â”€ persistence/           # æ•°æ®æŒä¹…åŒ–
â”‚   â”‚   â”‚   â””â”€â”€ repository/        # ä»“å‚¨å®ç°ï¼ˆGORMï¼‰
â”‚   â”‚   â””â”€â”€ writer/                # STRM å†™å…¥å™¨
â”‚   â”‚
â”‚   â”œâ”€â”€ pkg/                       # å…±äº«å·¥å…·åŒ…
â”‚   â”‚   â”œâ”€â”€ logger/                # æ—¥å¿—ç³»ç»Ÿ
â”‚   â”‚   â”œâ”€â”€ crypto/                # åŠ å¯†å·¥å…·
â”‚   â”‚   â”œâ”€â”€ hash/                  # å“ˆå¸Œå·¥å…·
â”‚   â”‚   â”œâ”€â”€ path/                  # è·¯å¾„å·¥å…·
â”‚   â”‚   â””â”€â”€ requestid/             # è¯·æ±‚IDç”Ÿæˆ
â”‚   â”‚
â”‚   â”œâ”€â”€ engine/                    # åŒæ­¥å¼•æ“ï¼ˆæ ¸å¿ƒä¸šåŠ¡é€»è¾‘ï¼‰
â”‚   â”œâ”€â”€ queue/                     # ä»»åŠ¡é˜Ÿåˆ—ï¼ˆSyncQueueï¼‰
â”‚   â”œâ”€â”€ scheduler/                 # ä»»åŠ¡è°ƒåº¦å™¨ï¼ˆCronï¼‰
â”‚   â”œâ”€â”€ worker/                    # ä»»åŠ¡æ‰§è¡Œå™¨ï¼ˆWorker Poolï¼‰
â”‚   â”‚
â”‚   â”œâ”€â”€ app/                       # åº”ç”¨å±‚
â”‚   â”‚   â””â”€â”€ service/               # ä¸šåŠ¡æœåŠ¡
â”‚   â”‚       â”œâ”€â”€ file.go            # æ–‡ä»¶æœåŠ¡
â”‚   â”‚       â”œâ”€â”€ job.go             # ä»»åŠ¡æœåŠ¡
â”‚   â”‚       â”œâ”€â”€ taskrun.go         # ä»»åŠ¡è¿è¡ŒæœåŠ¡
â”‚   â”‚       â””â”€â”€ ...
â”‚   â”‚
â”‚   â””â”€â”€ transport/                 # ä¼ è¾“å±‚
â”‚       â””â”€â”€ http/                  # HTTP å¤„ç†å™¨
â”‚           â”œâ”€â”€ job.go             # ä»»åŠ¡æ¥å£
â”‚           â”œâ”€â”€ filesystem_server.go  # æ–‡ä»¶ç³»ç»ŸæœåŠ¡å™¨æ¥å£
â”‚           â”œâ”€â”€ media_server.go    # åª’ä½“æœåŠ¡å™¨æ¥å£
â”‚           â””â”€â”€ ...
â”‚
â””â”€â”€ main.go                        # ç¨‹åºå…¥å£
```

## æ¶æ„è®¾è®¡åŸåˆ™

### 1. åˆ†å±‚æ¶æ„
- **é¢†åŸŸå±‚**: çº¯ä¸šåŠ¡æ¨¡å‹å’Œæ¥å£å®šä¹‰ï¼Œæ— å¤–éƒ¨ä¾èµ–
- **åŸºç¡€è®¾æ–½å±‚**: å®ç°é¢†åŸŸå±‚æ¥å£ï¼Œå¤„ç†å¤–éƒ¨ç³»ç»Ÿäº¤äº’
- **åº”ç”¨å±‚**: åè°ƒé¢†åŸŸå¯¹è±¡å®Œæˆä¸šåŠ¡ç”¨ä¾‹
- **ä¼ è¾“å±‚**: å¤„ç†å¤–éƒ¨è¯·æ±‚ï¼ˆHTTP/gRPCç­‰ï¼‰

### 2. ä¾èµ–å€’ç½®
- é«˜å±‚æ¨¡å—ï¼ˆdomainï¼‰å®šä¹‰æ¥å£
- ä½å±‚æ¨¡å—ï¼ˆinfraï¼‰å®ç°æ¥å£
- ä¾èµ–æ–¹å‘ï¼štransport â†’ app â†’ domain â† infra

### 3. Provider æ¨¡å¼
- filesystem ä½¿ç”¨ Provider æ³¨å†Œæ¨¡å¼
- é¿å…å¾ªç¯å¯¼å…¥
- æ”¯æŒåŠ¨æ€æ‰©å±•æ–°çš„æ–‡ä»¶ç³»ç»Ÿç±»å‹

### 4. Adapter æ¨¡å¼
- mediaserver ä½¿ç”¨ Adapter æ¨¡å¼
- ç»Ÿä¸€ä¸åŒåª’ä½“æœåŠ¡å™¨çš„æ¥å£å·®å¼‚
- æ˜“äºæ·»åŠ æ–°çš„åª’ä½“æœåŠ¡å™¨æ”¯æŒ

## ç¼–è¯‘å’Œæµ‹è¯•çŠ¶æ€

### ç¼–è¯‘çŠ¶æ€ âœ…
```bash
go build ./...
# ç¼–è¯‘æˆåŠŸï¼Œæ— é”™è¯¯
```

### æµ‹è¯•çŠ¶æ€ âœ…
```bash
go test ./...
# æ ¸å¿ƒæµ‹è¯•å…¨éƒ¨é€šè¿‡
âœ… internal/engine æµ‹è¯•é€šè¿‡
âœ… internal/queue æµ‹è¯•é€šè¿‡ (26 ä¸ªæµ‹è¯•)
âœ… internal/scheduler æµ‹è¯•é€šè¿‡ (8.5ç§’)
âœ… internal/worker æµ‹è¯•é€šè¿‡
âš ï¸ internal/infra/filesystem adapter æµ‹è¯•å¤±è´¥
   ï¼ˆå·²çŸ¥é™åˆ¶ï¼šåŒ…å†…æµ‹è¯•æ— æ³•å¯¼å…¥æ³¨å†Œçš„ providerï¼‰
```

## è¿ç§»å½±å“

### å¯¼å…¥è·¯å¾„å˜æ›´
- `core.*` â†’ `model.*`
- `utils.*` â†’ `logger.*` / `requestid.*`
- `syncengine/` â†’ `internal/engine/`
- `syncqueue/` â†’ `internal/queue/`
- `filesystem/` â†’ `internal/infra/filesystem/`
- `mediaserver/` â†’ `internal/infra/mediaserver/`
- `service/` â†’ `internal/app/service/`
- `handler/` â†’ `internal/transport/http/`

### ç ´åæ€§å˜æ›´
æ— ã€‚æ‰€æœ‰å¯¼å…¥è·¯å¾„å·²æ›´æ–°ï¼Œé¡¹ç›®å®Œå…¨å‘åå…¼å®¹ã€‚

## åç»­å»ºè®®

### 1. æ–‡æ¡£æ›´æ–°
- [ ] æ›´æ–° README.md ä¸­çš„æ¶æ„è¯´æ˜
- [ ] æ›´æ–°å¼€å‘æ–‡æ¡£ä¸­çš„ç›®å½•ç»“æ„
- [ ] æ·»åŠ å„å±‚èŒè´£è¯´æ˜

### 2. æµ‹è¯•æ”¹è¿›
- [ ] ä¸º filesystem adapter åˆ›å»ºç‹¬ç«‹æµ‹è¯•åŒ…
- [ ] å¢åŠ é›†æˆæµ‹è¯•è¦†ç›–ç‡
- [ ] æ·»åŠ  E2E æµ‹è¯•

### 3. æŒç»­ä¼˜åŒ–
- [ ] è€ƒè™‘å¼•å…¥ä¾èµ–æ³¨å…¥å®¹å™¨ï¼ˆwire/fxï¼‰
- [ ] è¯„ä¼°æ˜¯å¦éœ€è¦è¿›ä¸€æ­¥æ‹†åˆ†å¤§å‹æœåŠ¡
- [ ] è€ƒè™‘å¼•å…¥äº‹ä»¶é©±åŠ¨æ¶æ„

## æ€»ç»“

âœ… **æ¶æ„é‡æ„åœ†æ»¡å®Œæˆ**

- **3 ä¸ªé˜¶æ®µ**å…¨éƒ¨å®Œæˆ
- **77+ ä¸ªæ–‡ä»¶**æˆåŠŸè¿ç§»
- **ç¼–è¯‘é€šè¿‡**ï¼Œæ— é”™è¯¯
- **æ ¸å¿ƒæµ‹è¯•é€šè¿‡**ï¼Œè´¨é‡ä¿è¯
- **åˆ†å±‚æ¸…æ™°**ï¼ŒèŒè´£æ˜ç¡®
- **æ˜“äºæ‰©å±•**ï¼Œç»´æŠ¤æ€§å¼º

é¡¹ç›®ç°åœ¨å…·æœ‰ï¼š
- ğŸ—ï¸ æ¸…æ™°çš„åˆ†å±‚æ¶æ„
- ğŸ”Œ æ¾è€¦åˆçš„æ¨¡å—è®¾è®¡
- ğŸ“¦ å¯æ‰©å±•çš„ Provider æœºåˆ¶
- ğŸ§ª å®Œå–„çš„æµ‹è¯•è¦†ç›–
- ğŸ“š è‰¯å¥½çš„ä»£ç ç»„ç»‡

---

**é‡æ„å®Œæˆæ—¥æœŸ**: 2026-02-18
**åˆ†æ”¯**: refactor/architecture-v2
**æäº¤æ•°**: 3 (Stage 1-3)
