# STRMSync 项目整体规划

> **项目名称**: STRMSync - 自动化 STRM 媒体文件管理系统
> **技术栈**: Go 1.21+ (后端) + Vue 3 (前端) + Docker
> **预估总工期**: 10周 (50个工作日)
> **文档版本**: 1.0.0
> **创建日期**: 2026-02-16

---

## 📊 项目概览

```
总进度: [■□□□□□□□□□] 0% (0/10 阶段完成)

预估工期: 10周
当前阶段: 阶段0 - 环境清理和准备
```

---

## 🎯 阶段规划总览

| 阶段 | 名称 | 预估工时 | 依赖关系 | 状态 |
|------|------|----------|----------|------|
| 0️⃣ | 环境清理和准备 | 0.5天 | - | ⏳ 待开始 |
| 1️⃣ | 项目骨架 | 5天 | 阶段0 | 🔒 阻塞中 |
| 2️⃣ | 本地文件扫描 | 5天 | 阶段1 | 🔒 阻塞中 |
| 3️⃣ | CloudDrive2集成 | 5天 | 阶段2 | 🔒 阻塞中 |
| 4️⃣ | OpenList集成 | 5天 | 阶段2 | 🔒 阻塞中 |
| 5️⃣ | 文件监控和增量更新 | 5天 | 阶段2 | 🔒 阻塞中 |
| 6️⃣ | 元数据同步 | 5天 | 阶段2 | 🔒 阻塞中 |
| 7️⃣ | 媒体库通知 | 5天 | 阶段2 | 🔒 阻塞中 |
| 8️⃣ | Web前端 | 10天 | 阶段1 | 🔒 阻塞中 |
| 9️⃣ | 测试和优化 | 5天 | 阶段3-8 | 🔒 阻塞中 |

---

## 🔄 阶段依赖关系图

```
┌──────────────┐
│   阶段0      │  环境清理和准备 (0.5天)
│ 环境清理准备  │
└──────┬───────┘
       │
       ├─────────────────────────────┐
       ▼                             ▼
┌──────────────┐              ┌──────────────┐
│   阶段1      │              │   阶段8      │
│  项目骨架    │              │  Web前端     │
│   (5天)      │              │   (10天)     │
└──────┬───────┘              └──────────────┘
       │
       ▼
┌──────────────┐
│   阶段2      │  本地文件扫描 (5天)
│ 本地文件扫描  │  【核心阶段】
└──────┬───────┘
       │
       ├─────┬─────┬─────┬─────┐
       ▼     ▼     ▼     ▼     ▼
    ┌───┐ ┌───┐ ┌───┐ ┌───┐ ┌───┐
    │ 3 │ │ 4 │ │ 5 │ │ 6 │ │ 7 │  各5天
    └─┬─┘ └─┬─┘ └─┬─┘ └─┬─┘ └─┬─┘
      │     │     │     │     │
      └─────┴─────┴─────┴─────┘
                 │
                 ▼
          ┌──────────────┐
          │   阶段9      │
          │ 测试和优化    │
          │   (5天)      │
          └──────────────┘

说明:
- 阶段3: CloudDrive2集成
- 阶段4: OpenList集成
- 阶段5: 文件监控和增量更新
- 阶段6: 元数据同步
- 阶段7: 媒体库通知
```

---

## 📋 各阶段详细计划

### 【阶段0】环境清理和准备

**目标**: 清理Git工作区，准备干净的开发环境

**预估工时**: 0.5天

**子任务清单**:
- [ ] 检查并清理Git工作区状态（当前有大量文件标记为删除）
- [ ] 决策：恢复已删除文件 OR 重置工作区
- [ ] 确认项目根目录结构
- [ ] 确认必要的文档文件（README.md, CLAUDE.md等）存在

**验收标准**:
- ✅ Git工作区状态干净（git status无未提交变更）
- ✅ 项目文档完整
- ✅ 准备好进入阶段1开发

**状态**: ⏳ 待开始

---

### 【阶段1】项目骨架 - 基础架构搭建

**目标**: 搭建基础架构和Docker环境

**预估工时**: 5天

**依赖**: 阶段0

**子任务清单**:
1. [ ] 初始化Go项目（go mod init）
2. [ ] 创建项目目录结构
   - backend/cmd/server/
   - backend/internal/config/
   - backend/internal/database/
   - backend/internal/utils/
   - backend/internal/api/handlers/
   - config/, data/, logs/
3. [ ] 配置Makefile（build, run, test, docker命令）
4. [ ] 实现配置管理（Viper + 环境变量）
5. [ ] 实现数据库层（GORM + SQLite + 自动迁移）
6. [ ] 实现日志系统（Zap结构化日志）
7. [ ] 实现工具函数库（path, hash, crypto）
8. [ ] 创建主程序入口（main.go + Gin路由）
9. [ ] 实现健康检查接口 GET /api/health
10. [ ] 创建Docker配置（Dockerfile + docker-compose.yml）
11. [ ] 创建.env.example和配置文件示例

**验收标准**:
- ✅ Docker容器正常启动
- ✅ 数据库表自动创建
- ✅ /api/health 接口返回200
- ✅ 日志正常输出

**交付物**:
- backend/目录结构完整
- config/config.example.yaml
- .env.example
- Dockerfile
- docker-compose.yml
- Makefile

**状态**: 🔒 阻塞中（等待阶段0完成）

---

### 【阶段2】本地文件扫描 - 核心功能实现

**目标**: 实现本地文件系统的扫描和索引

**预估工时**: 5天

**依赖**: 阶段1

**子任务清单**:
1. [ ] 设计并实现Adapter接口
   - FileInfo结构体
   - Connect/Disconnect方法
   - ListFiles方法
   - GenerateSTRMContent方法
2. [ ] 实现LocalAdapter（本地文件系统适配器）
   - 文件遍历（递归/非递归）
   - 文件信息获取
   - STRM内容生成
3. [ ] 实现Scanner服务（扫描器）
   - 并发扫描（Goroutine池）
   - 视频文件过滤
   - 快速哈希计算
   - 重复文件检测
   - STRM文件生成和写入
4. [ ] 实现文件索引写入数据库
   - 批量写入优化
   - 事务处理
5. [ ] 实现数据源管理API
   - POST /api/sources - 创建数据源
   - GET /api/sources - 列出数据源
   - PUT /api/sources/:id - 更新数据源
   - DELETE /api/sources/:id - 删除数据源
   - POST /api/sources/:id/scan - 触发扫描
   - POST /api/sources/:id/test - 测试连接
6. [ ] 编写单元测试和集成测试

**验收标准**:
- ✅ 能扫描10万文件并建立索引
- ✅ 哈希计算准确无误
- ✅ STRM文件正确生成
- ✅ API接口功能正常

**交付物**:
- backend/internal/adapters/adapter.go
- backend/internal/adapters/local.go
- backend/internal/services/scanner.go
- backend/internal/api/handlers/sources.go
- 单元测试和集成测试

**状态**: 🔒 阻塞中（等待阶段1完成）

---

### 【阶段3】CloudDrive2集成 - 云盘支持

**目标**: 支持CloudDrive2数据源（仅本地挂载模式）

**预估工时**: 5天

**依赖**: 阶段2

**子任务清单**:
1. [ ] 生成CloudDrive2 gRPC客户端代码
2. [ ] 实现CloudDrive2Adapter
   - gRPC连接管理
   - 认证（密码/Token两种模式）
   - 文件列表获取
3. [ ] 实现STRM生成（本地挂载模式）
4. [ ] 实现健康检查和连接测试
5. [ ] 更新数据源管理API支持CloudDrive2类型
6. [ ] 编写CloudDrive2适配器测试

**验收标准**:
- ✅ 能连接CloudDrive2服务
- ✅ 能列出挂载文件
- ✅ STRM指向正确的挂载路径

**交付物**:
- backend/internal/adapters/clouddrive2.go
- CloudDrive2适配器测试

**状态**: 🔒 阻塞中（等待阶段2完成）

---

### 【阶段4】OpenList集成 - WebDAV支持

**目标**: 支持OpenList数据源（HTTP和本地两种模式）

**预估工时**: 5天

**依赖**: 阶段2

**子任务清单**:
1. [ ] 实现OpenListAdapter
   - REST API客户端封装
   - 认证（密码/Token两种模式）
2. [ ] 实现HTTP模式STRM生成
3. [ ] 实现本地模式STRM生成
4. [ ] 实现文件搜索功能
5. [ ] 更新数据源管理API支持OpenList类型
6. [ ] 编写OpenList适配器测试

**验收标准**:
- ✅ HTTP模式：STRM包含正确的下载URL
- ✅ 本地模式：STRM包含正确的挂载路径
- ✅ 两种模式可正确切换

**交付物**:
- backend/internal/adapters/openlist.go
- OpenList适配器测试

**状态**: 🔒 阻塞中（等待阶段2完成）

---

### 【阶段5】文件监控和增量更新 - 实时同步

**目标**: 实时监控文件变化，支持增量更新

**预估工时**: 5天

**依赖**: 阶段2

**子任务清单**:
1. [ ] 实现Watcher服务（基于fsnotify）
2. [ ] 实现事件处理器（Create/Write/Remove/Rename）
3. [ ] 实现事件去抖（防抖动）
4. [ ] 实现增量更新逻辑
5. [ ] 实现Watcher管理API
6. [ ] 编写监控服务测试

**验收标准**:
- ✅ 文件变更 < 5秒检测到
- ✅ 增量更新正确触发
- ✅ 无重复处理

**交付物**:
- backend/internal/services/watcher.go
- 监控服务测试

**状态**: 🔒 阻塞中（等待阶段2完成）

---

### 【阶段6】元数据同步 - 媒体信息管理

**目标**: 自动同步元数据文件（NFO/海报/字幕）

**预估工时**: 5天

**依赖**: 阶段2

**子任务清单**:
1. [ ] 实现元数据文件识别
2. [ ] 实现MetadataSync服务
3. [ ] 实现元数据索引
4. [ ] 实现元数据管理API
5. [ ] 集成到Scanner和Watcher服务
6. [ ] 编写元数据同步测试

**验收标准**:
- ✅ 元数据文件正确复制
- ✅ 目录结构保持一致
- ✅ 支持NFO/海报/字幕同步

**交付物**:
- backend/internal/services/metadata_sync.go
- 元数据同步测试

**状态**: 🔒 阻塞中（等待阶段2完成）

---

### 【阶段7】媒体库通知 - Emby/Jellyfin集成

**目标**: 集成Emby/Jellyfin，自动通知媒体库刷新

**预估工时**: 5天

**依赖**: 阶段2

**子任务清单**:
1. [ ] 实现EmbyNotifier
2. [ ] 实现JellyfinNotifier
3. [ ] 实现Notifier服务（通知队列）
4. [ ] 实现失败重试机制
5. [ ] 实现通知器管理API
6. [ ] 集成到Scanner、Watcher、MetadataSync服务
7. [ ] 编写通知服务测试

**验收标准**:
- ✅ Emby/Jellyfin能收到通知
- ✅ 媒体库正确刷新
- ✅ 批量通知工作正常

**交付物**:
- backend/internal/services/notifier.go
- backend/internal/services/emby_notifier.go
- backend/internal/services/jellyfin_notifier.go
- 通知服务测试

**状态**: 🔒 阻塞中（等待阶段2完成）

---

### 【阶段8】Web前端 - 管理界面

**目标**: 构建Vue 3管理界面

**预估工时**: 10天

**依赖**: 阶段1

**子任务清单**:
1. [ ] 初始化Vue 3项目
2. [ ] 集成Element Plus
3. [ ] 实现路由和布局
4. [ ] 实现API封装
5. [ ] 实现仪表盘页面
6. [ ] 实现数据源管理页面
7. [ ] 实现任务管理页面
8. [ ] 实现文件浏览页面
9. [ ] 实现系统设置页面
10. [ ] 实现单容器部署
11. [ ] 前端构建优化
12. [ ] 编写前端单元测试

**验收标准**:
- ✅ 所有页面功能正常
- ✅ UI响应流畅
- ✅ 表单验证完整

**交付物**:
- frontend/目录完整
- 所有页面组件
- API封装模块

**状态**: 🔒 阻塞中（等待阶段1完成）

---

### 【阶段9】测试和优化 - 质量保证

**目标**: 全面测试和性能优化

**预估工时**: 5天

**依赖**: 阶段3-8

**子任务清单**:
1. [ ] 单元测试（覆盖率 > 70%）
2. [ ] 集成测试
3. [ ] 性能测试（10万文件）
4. [ ] 性能优化
5. [ ] 压力测试
6. [ ] 安全加固
7. [ ] 文档完善
8. [ ] Docker镜像优化
9. [ ] 错误处理和日志优化
10. [ ] 监控和指标
11. [ ] 最终验收测试

**验收标准**:
- ✅ 扫描速度 > 3000文件/秒
- ✅ 内存占用 < 512MB
- ✅ Docker镜像 < 50MB
- ✅ 单元测试覆盖率 > 70%
- ✅ 文档完整

**交付物**:
- 完整的测试报告
- 性能测试报告
- 用户手册
- 开发者指南

**状态**: 🔒 阻塞中（等待阶段3-8完成）

---

## 📈 里程碑

| 里程碑 | 完成标志 | 预计日期 |
|--------|---------|---------|
| M1: 基础架构完成 | 阶段0-1完成 | Day 6 |
| M2: 核心扫描功能完成 | 阶段2完成 | Day 11 |
| M3: 所有数据源支持完成 | 阶段3-4完成 | Day 21 |
| M4: 后端功能完整 | 阶段5-7完成 | Day 36 |
| M5: 前端完成 | 阶段8完成 | Day 46 |
| M6: 项目交付 | 阶段9完成 | Day 51 |

---

## 🎯 当前行动建议

### 立即执行

**开始阶段0：环境清理和准备**

1. 清理Git工作区（git reset --hard 或 git checkout .）
2. 确认项目文档完整性
3. 准备进入阶段1开发

### 下一步

完成阶段0后，进入阶段1：项目骨架搭建

---

## 📝 备注

- **并行开发**: 阶段3-7可以在阶段2完成后并行开发
- **前端独立**: 阶段8可以在阶段1完成后独立开发
- **灵活调整**: 各阶段工时根据实际情况可适当调整
- **持续集成**: 每个阶段完成后需通过验收测试才能进入下一阶段

---

**文档维护**: 每完成一个阶段，更新本文档中的状态和进度

**Author**: STRMSync Team
**Last Update**: 2026-02-16
